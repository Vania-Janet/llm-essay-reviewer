# ğŸš€ Flask-Migrate (Alembic) - GuÃ­a RÃ¡pida

## âœ… Sistema Instalado y Configurado

Flask-Migrate estÃ¡ integrado en tu proyecto. Ya no necesitas `db.create_all()` ni scripts SQL manuales.

## ğŸ“‹ Comandos Principales

### 1. Ver Estado Actual
```bash
python manage.py current
```

### 2. Crear Nueva MigraciÃ³n (despuÃ©s de modificar models)
```bash
python manage.py migrate "DescripciÃ³n del cambio"
```

### 3. Aplicar Migraciones
```bash
python manage.py upgrade
```

### 4. Revertir Ãšltima MigraciÃ³n
```bash
python manage.py downgrade
```

### 5. Ver Historial
```bash
python manage.py history
```

## ğŸ¯ Ejemplo Real: Agregar Campo `fecha_modificacion`

### Paso 1: Modificar el Modelo
```python
# En database.py - Clase Ensayo
class Ensayo(db.Model):
    # ... campos existentes ...
    fecha_modificacion = db.Column(db.DateTime, onupdate=datetime.utcnow)
```

### Paso 2: Crear MigraciÃ³n
```bash
python manage.py migrate "Agregar campo fecha_modificacion a Ensayo"
```

**Salida:**
```
ğŸ“ Creando migraciÃ³n: Agregar campo fecha_modificacion a Ensayo
INFO  [alembic.autogenerate.compare] Detected added column 'ensayos.fecha_modificacion'
Generating /migrations/versions/abc123_agregar_campo_fecha.py ...  done
âœ… MigraciÃ³n creada exitosamente
```

### Paso 3: Revisar MigraciÃ³n Generada
```python
# migrations/versions/abc123_agregar_campo_fecha.py
def upgrade():
    # ### commands auto generated by Alembic ###
    op.add_column('ensayos', sa.Column('fecha_modificacion', sa.DateTime(), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic ###
    op.drop_column('ensayos', 'fecha_modificacion')
    # ### end Alembic commands ###
```

### Paso 4: Aplicar a la BD
```bash
python manage.py upgrade
```

**Salida:**
```
â¬†ï¸  Aplicando migraciones...
INFO  [alembic.runtime.migration] Running upgrade -> abc123, Agregar campo fecha_modificacion a Ensayo
âœ… Base de datos actualizada
```

### Paso 5: Verificar
```bash
python manage.py current
```

## ğŸ”¥ Ventajas vs `db.create_all()`

| Aspecto | `db.create_all()` | Flask-Migrate |
|---------|------------------|---------------|
| **Agregar campos** | âŒ Borra toda la BD | âœ… Solo agrega el campo |
| **Modificar tipos** | âŒ Error o pÃ©rdida | âœ… MigraciÃ³n automÃ¡tica |
| **Historial** | âŒ No existe | âœ… Versionado completo |
| **Rollback** | âŒ Imposible | âœ… `downgrade` |
| **Equipo** | âŒ Problemas sync | âœ… Git + migrations/ |
| **ProducciÃ³n** | âŒ Peligroso | âœ… Seguro |

## ğŸ“‚ Estructura Creada

```
/essay-agent
  /migrations/               â† Carpeta de Alembic
    /versions/              â† Cada migraciÃ³n aquÃ­
      abc123_initial.py
      def456_agregar_campo.py
    alembic.ini
    env.py
    README
  manage.py                 â† CLI de migraciones
  database.py              â† Models con migrate
```

## ğŸ› ï¸ Casos de Uso Comunes

### Agregar Campo Opcional
```python
# database.py
class Usuario(db.Model):
    telefono = db.Column(db.String(20), nullable=True)  # Nuevo campo

# Terminal
python manage.py migrate "Agregar telÃ©fono a Usuario"
python manage.py upgrade
```

### Agregar Campo Requerido (con default)
```python
class Ensayo(db.Model):
    estado = db.Column(db.String(20), default='borrador', nullable=False)

# Terminal
python manage.py migrate "Agregar estado a Ensayo"
# Editar migraciÃ³n para dar default a registros existentes
python manage.py upgrade
```

### Renombrar Campo (manual)
```python
# En la migraciÃ³n generada, modificar:
def upgrade():
    op.alter_column('ensayos', 'nombre_archivo', new_column_name='archivo_pdf')
```

### Agregar Ãndice
```python
class Ensayo(db.Model):
    autor = db.Column(db.String(200), index=True)  # Agregar index=True

# Terminal
python manage.py migrate "Agregar Ã­ndice a autor"
python manage.py upgrade
```

## ğŸš¨ Problemas Comunes

### "No changes detected"
**Causa:** Modelo ya existe en BD  
**SoluciÃ³n:** Solo detecta cambios incrementales

### Error al aplicar migraciÃ³n
```bash
# Marcar como aplicada sin ejecutar SQL
python manage.py stamp head
```

### Rehacer desde cero (DESARROLLO SOLO)
```bash
rm essays.db
rm -rf migrations/
python manage.py init
python manage.py migrate "Initial schema"
python manage.py upgrade
```

## ğŸ“ Mejores PrÃ¡cticas

1. **âœ… Siempre revisar** la migraciÃ³n generada antes de aplicar
2. **âœ… Mensajes descriptivos** en `migrate "mensaje claro"`
3. **âœ… Incluir /migrations/ en Git** (excepto __pycache__)
4. **âœ… Probar en desarrollo** antes de producciÃ³n
5. **âœ… Backup BD** antes de `upgrade` en producciÃ³n
6. **âŒ No editar** migraciones ya aplicadas
7. **âŒ No borrar** archivos de /migrations/versions/

## ğŸ“Š Estado Actual del Proyecto

- âœ… Flask-Migrate instalado
- âœ… `database.py` configurado
- âœ… `manage.py` CLI creado
- âœ… `/migrations/` inicializado
- âœ… Listo para crear migraciones

## ğŸ¯ PrÃ³ximo Paso

Cuando modifiques cualquier modelo en `database.py`:

```bash
python manage.py migrate "DescripciÃ³n del cambio"
python manage.py upgrade
```

Â¡Nunca mÃ¡s perderÃ¡s datos al agregar campos! ğŸš€
